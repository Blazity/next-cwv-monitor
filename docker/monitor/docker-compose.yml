version: "3.9"

x-clickhouse-env: &clickhouse-env
  CLICKHOUSE_HOST: &clickhouse-host ${CLICKHOUSE_HOST:-clickhouse}
  CLICKHOUSE_PORT: &clickhouse-port ${CLICKHOUSE_PORT:-8123}
  CLICKHOUSE_DB: &clickhouse-db ${CLICKHOUSE_DB:-cwv_monitor}
  CLICKHOUSE_USER: &clickhouse-user ${CLICKHOUSE_USER:-default}
  CLICKHOUSE_PASSWORD: &clickhouse-password ${CLICKHOUSE_PASSWORD:-secret}
  CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "1"

services:
  clickhouse:
    image: clickhouse/clickhouse-server:25.8
    restart: unless-stopped
    environment:
      <<: *clickhouse-env
    ports:
      - "8123:8123" # HTTP API
      - "9000:9000" # Native TCP
    healthcheck:
      test:
        [
          "CMD",
          "clickhouse-client",
          "--host",
          "localhost",
          "--query",
          "SELECT 1",
        ]
      interval: 5s
      retries: 10
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server

  migrations:
    image: node:20-alpine
    working_dir: /workspace
    volumes:
      - ../../:/workspace
    environment:
      CI: "true"
      <<: *clickhouse-env
      CH_MIGRATIONS_HOST: *clickhouse-host
      CH_MIGRATIONS_PORT: *clickhouse-port
      CH_MIGRATIONS_USER: *clickhouse-user
      CH_MIGRATIONS_PASSWORD: *clickhouse-password
      CH_MIGRATIONS_DATABASE: *clickhouse-db
      CH_MIGRATIONS_DIR: ${CH_MIGRATIONS_DIR:-clickhouse/migrations}
    command: >
      sh -c "
        corepack enable pnpm &&
        pnpm install --filter cwv-monitor-app --prod &&
        pnpm --filter cwv-monitor-app clickhouse:migrate
      "
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: "no"

  monitor-app:
    build:
      context: ../../
      dockerfile: docker/monitor/dockerfiles/monitor-app.prod.Dockerfile
    environment:
      AUTH_BASE_URL: ${AUTH_BASE_URL:-http://localhost:3000}
      # TRUST_PROXY controls whether we honor X-Forwarded-For/X-Real-IP headers.
      # Leave false unless the app runs behind a trusted reverse proxy.
      TRUST_PROXY: ${TRUST_PROXY:-false}
      <<: *clickhouse-env
    ports:
      - "3000:3000"
    depends_on:
      clickhouse:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    restart: unless-stopped

volumes:
  clickhouse-data:
  clickhouse-logs:
