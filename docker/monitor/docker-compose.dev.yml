version: "3.9"

x-clickhouse-env: &clickhouse-env
  CLICKHOUSE_HOST: &clickhouse-host ${CLICKHOUSE_HOST:-clickhouse}
  CLICKHOUSE_PORT: &clickhouse-port ${CLICKHOUSE_PORT:-8123}
  CLICKHOUSE_DB: &clickhouse-db ${CLICKHOUSE_DB:-cwv_monitor}
  CLICKHOUSE_USER: &clickhouse-user ${CLICKHOUSE_USER:-default}
  CLICKHOUSE_PASSWORD: &clickhouse-password ${CLICKHOUSE_PASSWORD:-secret}
  CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "1"

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: cwv-clickhouse-dev
    restart: unless-stopped
    environment:
      <<: *clickhouse-env
    ports:
      - "8123:8123" # HTTP API
      - "9000:9000" # Native TCP
    healthcheck:
      test:
        [
          "CMD",
          "clickhouse-client",
          "--host",
          "localhost",
          "--query",
          "SELECT 1",
        ]
      interval: 5s
      retries: 10
    volumes:
      - clickhouse-dev-data:/var/lib/clickhouse
      - clickhouse-dev-logs:/var/log/clickhouse-server

  migrations:
    image: node:20-alpine
    container_name: cwv-clickhouse-migrations-dev
    working_dir: /workspace
    volumes:
      - ../../:/workspace
    environment:
      CI: "true"
      <<: *clickhouse-env
      CH_MIGRATIONS_HOST: *clickhouse-host
      CH_MIGRATIONS_PORT: *clickhouse-port
      CH_MIGRATIONS_USER: *clickhouse-user
      CH_MIGRATIONS_PASSWORD: *clickhouse-password
      CH_MIGRATIONS_DATABASE: *clickhouse-db
      CH_MIGRATIONS_DIR: ${CH_MIGRATIONS_DIR:-clickhouse/migrations}
    command: >
      sh -c "corepack enable pnpm && pnpm install --filter cwv-monitor-app && pnpm --filter cwv-monitor-app clickhouse:migrate"
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: "no"

  seed-demo:
    image: node:20-alpine
    container_name: cwv-monitor-seed-dev
    working_dir: /workspace
    volumes:
      - ../../:/workspace
    environment:
      CI: "true"
      <<: *clickhouse-env
    command: >
      sh -c "corepack enable pnpm && pnpm install --filter cwv-monitor-app && pnpm --filter cwv-monitor-app seed:demo"
    depends_on:
      clickhouse:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    restart: "no"

  monitor-app:
    build:
      context: ../../
      dockerfile: docker/monitor/dockerfiles/monitor-app.dev.Dockerfile
    container_name: cwv-monitor-app-dev
    environment:
      NODE_ENV: development
      <<: *clickhouse-env
      TRUST_PROXY: ${TRUST_PROXY:-false}
      AUTH_BASE_URL: ${AUTH_BASE_URL:-http://localhost:3000}
    ports:
      - "3000:3000"
    volumes:
      - ../../:/app
      - monitor-app-dev-node-modules:/app/node_modules
    depends_on:
      clickhouse:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    restart: unless-stopped

volumes:
  clickhouse-dev-data:
  clickhouse-dev-logs:
  monitor-app-dev-node-modules:
