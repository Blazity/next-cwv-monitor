# Development Docker Compose

x-clickhouse-env: &clickhouse-env
  CLICKHOUSE_HOST: ${CLICKHOUSE_HOST:-clickhouse}
  CLICKHOUSE_PORT: ${CLICKHOUSE_PORT:-8123}
  CLICKHOUSE_DB: ${CLICKHOUSE_DB:-cwv_monitor}
  CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
  CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-secret}
  AI_ANALYST_CLICKHOUSE_USER: ${AI_ANALYST_CLICKHOUSE_USER:-ai_analyst_user}
  AI_ANALYST_CLICKHOUSE_PASSWORD: ${AI_ANALYST_CLICKHOUSE_PASSWORD:-analyst_secret}

services:
  clickhouse:
    image: clickhouse/clickhouse-server:${CLICKHOUSE_VERSION:-25.8}
    container_name: cwv-clickhouse-dev
    restart: unless-stopped
    environment:
      <<: *clickhouse-env
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "1"
    ports:
      - "8123:8123"
      - "9000:9000"
    healthcheck:
      test:
        [
          "CMD",
          "clickhouse-client",
          "--host",
          "localhost",
          "--query",
          "SELECT 1",
        ]
      interval: 5s
      retries: 10
    volumes:
      - clickhouse-dev-data:/var/lib/clickhouse
      - clickhouse-dev-logs:/var/log/clickhouse-server

  migrations:
    image: node:24-alpine
    container_name: cwv-migrations-dev
    working_dir: /workspace
    volumes:
      - ../:/workspace
    environment:
      CI: "true"
      <<: *clickhouse-env
      CH_MIGRATIONS_HOST: ${CLICKHOUSE_HOST:-clickhouse}
      CH_MIGRATIONS_PORT: ${CLICKHOUSE_PORT:-8123}
      CH_MIGRATIONS_USER: ${CLICKHOUSE_USER:-default}
      CH_MIGRATIONS_PASSWORD: ${CLICKHOUSE_PASSWORD:-secret}
      CH_MIGRATIONS_DATABASE: ${CLICKHOUSE_DB:-cwv_monitor}
      CH_MIGRATIONS_DIR: ${CH_MIGRATIONS_DIR:-clickhouse/migrations}
    command: >
      sh -c "corepack enable pnpm && pnpm install --filter cwv-monitor-app && pnpm --filter cwv-monitor-app clickhouse:migrate"
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: "no"

  seed-demo:
    image: node:24-alpine
    container_name: cwv-seed-dev
    working_dir: /workspace
    volumes:
      - ../:/workspace
    environment:
      CI: "true"
      <<: *clickhouse-env
    command: >
      sh -c "corepack enable pnpm && pnpm install --filter cwv-monitor-app && pnpm --filter cwv-monitor-app seed:demo"
    depends_on:
      migrations:
        condition: service_completed_successfully
    restart: "no"

  monitor-app:
    build:
      context: ../
      dockerfile: docker/monitor-app.dev.Dockerfile
    container_name: cwv-monitor-dev
    environment:
      NODE_ENV: development
      <<: *clickhouse-env
      TRUST_PROXY: ${TRUST_PROXY:-false}
      AUTH_BASE_URL: ${AUTH_BASE_URL:-http://localhost:3000}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-dev-secret-not-for-production-123}
      INITIAL_USER_EMAIL: ${INITIAL_USER_EMAIL:-user@example.com}
      INITIAL_USER_PASSWORD: ${INITIAL_USER_PASSWORD:-password}
      INITIAL_USER_NAME: ${INITIAL_USER_NAME:-User}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
    ports:
      - "${APP_PORT:-3000}:3000"
    volumes:
      - ../:/app
      - monitor-app-dev-node-modules:/app/node_modules
    depends_on:
      clickhouse:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    restart: unless-stopped

  cwv-worker:
    image: node:24-alpine
    container_name: cwv-worker-dev
    working_dir: /workspace
    volumes:
      - ../:/workspace
    environment:
      CI: "true"
      <<: *clickhouse-env
      NODE_ENV: development
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-https://localhost/placeholder}
      TEAMS_WEBHOOK_URL: ${TEAMS_WEBHOOK_URL:-https://localhost/placeholder}
      AUTH_BASE_URL: ${AUTH_BASE_URL:-http://localhost:3000}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-dev-secret-not-for-production-123}
      INITIAL_USER_EMAIL: ${INITIAL_USER_EMAIL:-user@example.com}
      INITIAL_USER_PASSWORD: ${INITIAL_USER_PASSWORD:-password}
      INITIAL_USER_NAME: ${INITIAL_USER_NAME:-User}
    command: >
      sh -c "corepack enable pnpm && pnpm install --filter anomaly-worker && pnpm --filter anomaly-worker dev"
    depends_on:
      clickhouse:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    restart: unless-stopped

volumes:
  clickhouse-dev-data:
  clickhouse-dev-logs:
  monitor-app-dev-node-modules:
