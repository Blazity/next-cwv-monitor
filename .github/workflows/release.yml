name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  id-token: write
  packages: write

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      sdk_new_tag: ${{ steps.sdk-tag.outputs.new_tag }}
      sdk_tag: ${{ steps.sdk-tag.outputs.tag }}
      sdk_version: ${{ steps.sdk-tag.outputs.version }}
      app_new_tag: ${{ steps.app-tag.outputs.new_tag }}
      app_tag: ${{ steps.app-tag.outputs.tag }}
      app_version: ${{ steps.app-tag.outputs.version }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"
          cache: "pnpm"

      - name: Update npm for Trusted Publishers
        run: npm install -g npm@latest

      - name: Install & Build
        run: |
          pnpm install --frozen-lockfile
          pnpm --filter next-cwv-monitor build

      - name: Size Guard
        run: pnpm --filter next-cwv-monitor check-size

      - name: Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm release
          version: pnpm version-packages
          commit: "chore: release packages"
          title: "chore: release packages"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Create SDK Git Tag
        id: sdk-tag
        if: steps.changesets.outputs.published == 'true'
        run: |
          git fetch --tags

          SDK_VERSION=$(echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[] | select(.name == "next-cwv-monitor") | .version')
          SDK_TAG="next-cwv-monitor-v${SDK_VERSION}"

          echo "version=${SDK_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${SDK_TAG}" >> "$GITHUB_OUTPUT"

          if [ -z "$SDK_VERSION" ]; then
            echo "new_tag=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git tag -l "${SDK_TAG}" | grep -q .; then
            echo "Tag ${SDK_TAG} already exists, skipping"
            echo "new_tag=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Creating tag ${SDK_TAG} at ${GITHUB_SHA}"
          git tag "${SDK_TAG}" "${GITHUB_SHA}"
          git push origin "${SDK_TAG}"
          echo "new_tag=true" >> "$GITHUB_OUTPUT"

      - name: Create Monitor App Git Tag
        id: app-tag
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: |
          git fetch --tags

          # Create tag for monitor-app if it doesn't exist for current version
          APP_VERSION=$(jq -r '.version' apps/monitor-app/package.json)
          APP_TAG="monitor-app-v${APP_VERSION}"

          echo "version=${APP_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${APP_TAG}" >> "$GITHUB_OUTPUT"

          if ! git tag -l "${APP_TAG}" | grep -q .; then
            echo "Creating tag ${APP_TAG} at ${GITHUB_SHA}"
            git tag "${APP_TAG}" "${GITHUB_SHA}"
            git push origin "${APP_TAG}"
            echo "new_tag=true" >> "$GITHUB_OUTPUT"
          else
            echo "Tag ${APP_TAG} already exists, skipping"
            echo "new_tag=false" >> "$GITHUB_OUTPUT"
          fi

  docker:
    name: Build Docker Images
    needs: release
    if: needs.release.outputs.app_new_tag == 'true'
    uses: ./.github/workflows/docker-publish.yml
    with:
      tag: ${{ needs.release.outputs.app_version }}
    permissions:
      contents: read
      packages: write

  sdk_github_release:
    name: Create SDK GitHub Release
    needs: release
    if: needs.release.outputs.sdk_new_tag == 'true'
    uses: ./.github/workflows/create-github-release.yml
    with:
      tag: ${{ needs.release.outputs.sdk_tag }}
    permissions:
      contents: write

  monitor_app_github_release:
    name: Create Monitor App GitHub Release
    needs: [release, docker]
    if: needs.release.outputs.app_new_tag == 'true'
    uses: ./.github/workflows/create-github-release.yml
    with:
      tag: ${{ needs.release.outputs.app_tag }}
    permissions:
      contents: write
