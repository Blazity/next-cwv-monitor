name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  id-token: write
  packages: write

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      app_new_tag: ${{ steps.app-tag.outputs.new_tag }}
      app_version: ${{ steps.app-tag.outputs.version }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"
          cache: "pnpm"

      - name: Update npm for Trusted Publishers
        run: npm install -g npm@latest

      - name: Install & Build
        run: |
          pnpm install --frozen-lockfile
          pnpm --filter next-cwv-monitor build

      - name: Size Guard
        run: pnpm --filter next-cwv-monitor check-size

      - name: Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm release
          version: pnpm version-packages
          commit: "chore: release packages"
          title: "chore: release packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Create SDK Git Tag
        if: steps.changesets.outputs.published == 'true'
        run: |
          SDK_VERSION=$(echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[] | select(.name == "next-cwv-monitor") | .version')
          if [ -n "$SDK_VERSION" ]; then
            echo "Creating tag next-cwv-monitor-v${SDK_VERSION}"
            git tag "next-cwv-monitor-v${SDK_VERSION}"
            git push origin "next-cwv-monitor-v${SDK_VERSION}"
          fi

      - name: Create Monitor App Git Tag
        id: app-tag
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: |
          git fetch --tags

          # Create tag for monitor-app if it doesn't exist for current version
          APP_VERSION=$(jq -r '.version' apps/monitor-app/package.json)
          echo "version=${APP_VERSION}" >> $GITHUB_OUTPUT

          if ! git tag -l "monitor-app-v${APP_VERSION}" | grep -q .; then
            echo "Creating tag monitor-app-v${APP_VERSION}"
            git tag "monitor-app-v${APP_VERSION}"
            git push origin "monitor-app-v${APP_VERSION}"
            echo "new_tag=true" >> $GITHUB_OUTPUT
          else
            echo "Tag monitor-app-v${APP_VERSION} already exists, skipping"
            echo "new_tag=false" >> $GITHUB_OUTPUT
          fi

  docker:
    name: Build Docker Images
    needs: release
    if: needs.release.outputs.app_new_tag == 'true'
    uses: ./.github/workflows/docker-publish.yml
    with:
      tag: ${{ needs.release.outputs.app_version }}
    permissions:
      contents: read
      packages: write
