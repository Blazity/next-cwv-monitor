# Self-host Next CWV Monitor

Deploy Next CWV Monitor on your own infrastructure.

## Quick Start

Run the interactive setup wizard:

```bash
curl -fsSL https://raw.githubusercontent.com/Blazity/next-cwv-monitor/main/setup.sh | bash
```

The wizard will:

1. Download the required Docker Compose files
2. Guide you through configuring SSL (optional, via Caddy)
3. Set up your admin account
4. Generate secure secrets automatically
5. Create the `.env` file

Once complete, start the services:

```bash
cd ~/cwv-monitor
docker compose up -d
```

> **With SSL enabled:** `docker compose -f docker-compose.yml -f docker-compose.ssl.yml up -d`

Open your configured URL and log in with the admin credentials you provided.

---

## Configuration

The setup wizard creates a `.env` file automatically. For reference, here are the available variables:

### Required

| Variable                | Description          | Example                   |
| ----------------------- | -------------------- | ------------------------- |
| `CLICKHOUSE_PASSWORD`   | ClickHouse password  | `secret`                  |
| `BETTER_AUTH_SECRET`    | Auth token secret    | `openssl rand -base64 32` |
| `AUTH_BASE_URL`         | Public URL           | `https://cwv.example.com` |
| `INITIAL_USER_EMAIL`    | First admin email    | `user@example.com`        |
| `INITIAL_USER_PASSWORD` | First admin password | `password`                |

### Optional

| Variable            | Default | Description                        |
| ------------------- | ------- | ---------------------------------- |
| `APP_PORT`          | `80`    | Host port for the app              |
| `TRUST_PROXY`       | `false` | Enable when behind a reverse proxy |
| `INITIAL_USER_NAME` | `Admin` | First admin display name           |
| `LOG_LEVEL`         | `info`  | `debug`, `info`, `warn`, `error`   |

<details>
<summary>ClickHouse options (for external clusters)</summary>

| Variable          | Default       |
| ----------------- | ------------- |
| `CLICKHOUSE_HOST` | `clickhouse`  |
| `CLICKHOUSE_PORT` | `8123`        |
| `CLICKHOUSE_USER` | `default`     |
| `CLICKHOUSE_DB`   | `cwv_monitor` |

</details>

---

## Alternative Deployment Options

### Build from Source

Build images locally instead of pulling from registry:

```bash
git clone https://github.com/blazity/next-cwv-monitor.git
cd next-cwv-monitor/docker
docker compose -f docker-compose.yml -f docker-compose.build.yml up -d --build
```

> Requires a `.env` file in the `docker/` directory (see Configuration section above).

### External ClickHouse

If you have an existing ClickHouse cluster:

1. Run migrations:

   ```bash
   export CLICKHOUSE_HOST=your-host CLICKHOUSE_PASSWORD=your-pass
   pnpm --filter cwv-monitor-app clickhouse:migrate
   ```

2. Run the app (from repo root):
   ```bash
   docker build -f docker/monitor-app.prod.Dockerfile -t cwv-monitor .
   docker run -p 3000:3000 --env-file docker/.env cwv-monitor
   ```

---

## Troubleshooting

```bash
# Check status
docker ps

# View logs (from your installation directory)
cd ~/cwv-monitor && docker compose logs -f
cd ~/cwv-monitor && docker compose logs -f monitor-app

# Reset everything (deletes all data)
cd ~/cwv-monitor && docker compose down -v && docker compose up -d
```

**Common issues:**

- **"ClickHouse connection refused"** — Wait 30s for ClickHouse to start
- **"Auth error"** — Ensure `AUTH_BASE_URL` matches your actual URL exactly
- **"Rate limited"** — Set `TRUST_PROXY=true` if behind a proxy

---

## Security Checklist

- [x] Strong `BETTER_AUTH_SECRET` (auto-generated by setup wizard)
- [x] Strong `CLICKHOUSE_PASSWORD` (auto-generated by setup wizard)
- [ ] HTTPS in production (enable SSL mode in setup wizard, or use `AUTH_BASE_URL` with `https://`)
- [ ] Firewall: only expose ports 80/443 (SSL mode) or `APP_PORT`
- [ ] `TRUST_PROXY=true` only when behind a trusted proxy (auto-set in SSL mode)

---

## Data Retention

| Data             | Retention |
| ---------------- | --------- |
| Raw CWV events   | 90 days   |
| Custom events    | 90 days   |
| Daily aggregates | 365 days  |

Edit TTL in migration files before first deployment to customize.

---

## Resources

- [Architecture Guide](./ARCHITECTURE.md)
- [Contributing Guide](./CONTRIBUTING.md)
